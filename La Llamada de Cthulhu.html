<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="userinfo"  />
<span style="display: none" data-i18n="attributes-u">Test</span>
<div class="tab">
    <button class="userinfo" type="action" name="act_userinfo">Información Personal</button>
    <button class="character" type="action" name="act_character">Características y Puntuaciones</button>
    <button class="items" type="action" name="act_items">Equipo y armas</button>
</div>

<div class="tabcontent sheet-userinfo">
    <h2>Informacion Personal</h2>
    <div>
        <span>Nombre del investigador</span>
        <input type="text" name="attr_Name" style="max-width: 300px" />
    </div>

</div>

<rolltemplate class="sheet-rolltemplate-test">

</rolltemplate>

<div class="tabcontent sheet-character" >
    <h2>Características y Habilidades</h2>
    <br />
    <h3>
        <span class="header">Características</span>
    </h3>
    <div class="reset-button">
        <button type="action" class="reset-button" name="act_reset" >Reiniciar</button>
    </div>

    <table>
        <tbody>
        <tr>
            <td data-i18n="FUE-u"/>
            <td>
                <input type="number" min="3" value="3" name="attr_FUE" />
                <button type="roll" name="roll_FUE" value="&{template:default} {{name=@{character_name}}} {{Roll=^{FUE-u}}} {{Puntuacion=@{FUE}}} {{Resultado=[[1d100/@{FUE}]]}}"/>
            </td>
            <td data-i18n="DES-u"/>
            <td>
                <input type="number" min="3" value="3" name="attr_DES" />
                <button type="roll" name="roll_DES" value="&{template:default} {{name=@{character_name}}} {{Roll=^{DES-u}}} {{Puntuacion=@{DES}}} {{Resultado=[[1d100/@{DES}]]}}"/>
            </td>
            <td data-i18n="INT-u"/>
            <td>
                <input type="number" min="8" value="8" name="attr_INT" />
                <button type="roll" name="roll_INT" value="&{template:default} {{name=@{character_name}}} {{Roll=^{INT-u}}} {{Puntuacion=@{INT}}} {{Resultado=[[1d100/@{INT}]]}}"/>
            </td>
        </tr>
        <tr>
            <td data-i18n="CON-u"/>
            <td>
                <input type="number" min="3" value="3" name="attr_CON" />
                <button type="roll" name="roll_CON" value="&{template:default} {{name=@{character_name}}} {{Roll=^{CON-u}}} {{Puntuacion=@{CON}}} {{Resultado=[[1d100/@{CON}]]}}"/>
            </td>
            <td data-i18n="APA-u"/>
            <td>
                <input type="number" min="3" value="3" name="attr_APA" />
                <button type="roll" name="roll_APA" value="&{template:default} {{name=@{character_name}}} {{Roll=^{APA-u}}} {{Puntuacion=@{APA}}} {{Resultado=[[1d100/@{APA}]]}}"/>
            </td>
            <td data-i18n="POD-u"/>
            <td>
                <input type="number" min="3" value="3" name="attr_POD" />
                <button type="roll" name="roll_POD" value="&{template:default} {{name=@{character_name}}} {{Roll=^{POD-u}}} {{Puntuacion=@{POD}}} {{Resultado=[[1d100/@{POD}]]}}"/>
            </td>

        </tr>
        <tr>
            <td data-i18n="TAM-u"/>
            <td>
                <input type="number" min="8" max="18" value="8" name="attr_TAM" />
                <button type="roll" name="roll_TAM" value="&{template:default} {{name=@{character_name}}} {{Roll=^{TAM-u}}} {{Puntuacion=@{TAM}}} {{Resultado=[[1d100/@{TAM}]]}}"/>
            </td>
            <td data-i18n="COR-u" />
            <td>
                <input type="number" value="5*@{POD}" disabled="true" name="attr_COR" />
            </td>
            <td data-i18n="EDU-u">Educación</td>
            <td>
                <input type="number" min="6" max="18" value="6" name="attr_EDU" />
                <button type="roll" name="roll_EDU" value="&{template:default} {{name=@{character_name}}} {{Roll=^{EDU-u}}} {{Puntuacion=@{EDU}}} {{Resultado=[[1d100/@{EDU}]]}}"/>
            </td>

        </tr>
        </tbody>
    </table>
    <br/>
    <br/>
    <h3><span>Atributos secundarios</span></h3>
    <div>
        <button type="roll" name="roll_default" value="%{Test}" >Reiniciar</button>
    </div>
    <div class="secondary">
        <div class="tr">
            <div class="td">
                <span data-i18n="idea-u"></span>
                <div>
                    <input type="number" name="attr_Idea" value="[[5*@{INT}]]" disabled="true" />
                    <button type="roll" name="roll_Idea" value="/roll 1d100<@{Idea}" />
                </div>
            </div>
            <div class="td">
                <span data-i18n="luck-u"></span>
                <div>
                    <input type="number" name="attr_Luck" value="[[5*@{POD}]]" disabled="true" />
                    <button type="roll" name="roll_Luck" value="/roll 1d100<@{Luck}" />
                </div>
            </div>
            <div class="td">
                <span data-i18n="know-u"></span>
                <div>
                    <input type="number" name="attr_Know" value="[[5*@{EDU}]]" disabled="true" />
                    <button type="roll" name="roll_Know" value="/roll 1d100<@{Know}" />
                </div>
            </div>
        </div>
        <div class="tr">
            <div class="td">
                <span data-i18n="dmg-bonus-u" ></span>
                <div>
                    <input type="text" readonly="true" name="attr_DMG" style="width: 3.5em;" />
                </div>
            </div>
            <div class="td">
                <span data-i18n="stable-sanity-u" ></span>
                <div>
                    <input type="number" readonly="true" name="attr_Max-Sanity" value="(99-@{Cthulhu-Mythos})" />
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tabcontent sheet-items" >
    <h2>Items</h2>
</div>

<script type="text/worker">

    var DAMAGE_BONUS = {
        table: [
            {bonus: '-1d6', range: _.range( 0,  12)},
            {bonus: '-1d4', range: _.range( 13, 16)},
            {bonus:    '0', range: _.range( 17, 24)},
            {bonus:  '1d4', range: _.range( 25, 32)},
            {bonus:  '1d6', range: _.range( 33, 40)},
            {bonus:  '2d6', range: _.range( 42, 56)},
            {bonus:  '3d6', range: _.range( 57, 72)},
            {bonus:  '4d6', range: _.range( 73, 88)},
            {bonus:  '5d6', range: _.range( 89,104)},
            {bonus:  '6d6', range: _.range(105,120)},
            {bonus:  '7d6', range: _.range(121,136)},
            {bonus:  '8d6', range: _.range(137,152)},
            {bonus:  '9d6', range: _.range(153,168)},
            {bonus: '10d6', range: _.range(169,184)},
            {bonus: '11d6', range: _.range(185,200)},
            {bonus: '12d6', range: _.range(201,216)},
            {bonus: '13d6', range: _.range(217,232)},
            {bonus: '14d6', range: _.range(233,248)},
            {bonus: '21d6', range: _.range(249,999)},
        ],
        getBonusForValue : function(value) {
            var checkRange = function(entry) { return entry.range.indexOf(parseInt(value||0)) !== -1 };
            var tableEntry = _.find(this.table, checkRange);
            return tableEntry.bonus;
        }
    }


    const buttonlist = ["userinfo", "character", "items"];
    buttonlist.forEach(button => {
            on(`clicked:${button}`, function(e) {
            setAttrs({
                sheetTab: button
            })
            });
    });
    var attributes = {
        "FUE": {"default": 3, "min":3},
        "DES": {"default": 3, "min":3},
        "INT": {"default": 8, "min":8},
        "CON": {"default": 3, "min":3},
        "APA": {"default": 3, "min":3},
        "POD": {"default": 3, "min":3},
        "TAM": {"default": 8, "min":8},
        "EDU": {"default": 6, "min":6}
    }
    Object.entries(attributes).forEach(items => {
        var stat = items[0]
        var stats = items[1]
        on(`change:${stat}`, function(e) {
            console.log(e)
            if(stat == "FUE" || stat == "TAM"){
                getAttrs(["FUE", "TAM"], function(values){
                    var v = parseInt(values.FUE) + parseInt(values.TAM)
                    var damage_bonus = DAMAGE_BONUS.getBonusForValue(v);
                    setAttrs({
                        "DMG": damage_bonus
                    })

                })
            }
        })
    })

    function reset(){
        var attrs = {}
        Object.entries(attributes).forEach(items => {
            var stat = items[0]
            var stats = items[1]
            attrs[stat] = stats["default"]
        })
        setAttrs(attrs)
    }

    on("clicked:reset", function(){
        reset()
    })

    on("sheet:opened", function(eventInfo){
        getAttrs(Object.keys(attributes), function(values) {
            setAttrs(values)
        })
    })


</script>